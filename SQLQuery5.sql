SELECT P.[ProjectId]              ,[ProjectName]        ,[CustomerName]       ,[CustomerID] as [Customer_ID]        ,[ProjectManagerNameFL]        ,[SeniorProjectManagerNameFL]        ,[ProjectBillerNameFL]      ,[ProjectCompanyName]      ,(SELECT [CostCenterName] FROM [ankura_dw].[dbo].[CostCenters] CC where CC.[CostCenterId] = ProjectCostCenterId ) as ProjectCostCenterId            ,[ProjectDeptLevel4]        ,[ProjectDeptLevel5]      ,CustomerInvoiceID  as [Customer_Invoice_Reference_ID]        ,CustomerInvoiceID as [Invoice_Number]        ,InvoiceAccountingDate as [AccountingDate]      ,DATEDIFF(day,[InvoiceDate],CAST(GETDATE() AS DATE)) as Aging_Days_Invoice_Date      ,DueDate as [Due_Date]        ,Project_Currency as [LedgerCurrencyId]      , (select CAST( max([PaymentDate]) AS DATE)  FROM [ankura_dw].[dbo].[CustomerPayments] P           where PATINDEX('%'+CIS.[CustomerInvoiceID]+'%', Customer_Invoice_Reference_ID ) > 0          ) as [Most_Recent_Payment_Date]          , (select  isnull(sum([Payment_Amount]), 0)  FROM [ankura_dw].[dbo].[CustomerPayments] P           where PATINDEX('%'+CIS.[CustomerInvoiceID]+'%', Customer_Invoice_Reference_ID ) > 0            and [PaymentDate] >= DATEADD(day,-31, CAST(GETDATE() AS DATE)) -- last 30 days          ) as [Paid_Last30_Local]      , (select  isnull(sum([Payment_Amount]), 0) FROM [ankura_dw].[dbo].[CustomerPayments] P           where PATINDEX('%'+CIS.[CustomerInvoiceID]+'%', Customer_Invoice_Reference_ID ) > 0            and [PaymentDate] >= DATEFROMPARTS(DATEPART(year, DATEADD(day,-1, CAST(GETDATE() AS DATE))), DATEPART(month, DATEADD(day,-1, CAST(GETDATE() AS DATE))), 1)           ) as [Paid_MTD_Local]        , (select  isnull(sum([Payment_Amount]), 0)  FROM [ankura_dw].[dbo].[CustomerPayments] P           where PATINDEX('%'+CIS.[CustomerInvoiceID]+'%', Customer_Invoice_Reference_ID ) > 0            and [PaymentDate] >= DATEADD(day,-31, CAST(GETDATE() AS DATE)) -- last 30 days          ) as [Paid_Last30_USD]      , (select  isnull(sum([Payment_Amount]), 0)  FROM [ankura_dw].[dbo].[CustomerPayments] P           where PATINDEX('%'+CIS.[CustomerInvoiceID]+'%', Customer_Invoice_Reference_ID ) > 0             and [PaymentDate] >= DATEFROMPARTS(DATEPART(year, DATEADD(day,-1, CAST(GETDATE() AS DATE))), DATEPART(month, DATEADD(day,-1, CAST(GETDATE() AS DATE))), '1')           ) as [Paid_MTD_USD]        ,[Retainer_Balance__USD]        ,PaymentTerms as [Payment_Terms_ID]         ,CIS.[InvoiceDate]                 ,[TotalInvoiceAmount] as Invoice_Amount_Local      ,[CustomerInvoiceTotalAmountInUSD] as Invoice_Amount_USD        ,[AmountDue]    as Amount_Due_Local      ,[AmountDueInUSD2]  as Amount_Due_USD              ,[TotalPaymentsExcludingWriteoffs]  as [Total_Payments_Local]      ,[TotalPaymentsExcludingWriteoffsInUSD]  as [Total_Payments_USD]          ,[TotalWriteoffAmountApprovedandNotCanceled] as Total_Writeoffs_Local      ,[TotalWriteoffAmountApprovedandNotCanceledUSD] as Total_Writeoffs_USD         , (select CAST( max([PaymentDate]) AS DATE)  FROM [ankura_dw].[dbo].[CustInvoiceWriteoffs] W           where W.CustomerInvoiceID = CIS.InvoiceNumber          ) as [Most_Recent_Write-off_Date]           , (select sum([WriteoffAmount]) FROM [ankura_dw].[dbo].[CustInvoiceWriteoffs] W           where W.CustomerInvoiceID = CIS.InvoiceNumber            and [PaymentDate] >= DATEADD(day,-31, CAST(GETDATE() AS DATE))           ) as [Writeoffs_in_the_last_30_days_Local]           , (select sum([WriteoffAmountUSD]) FROM [ankura_dw].[dbo].[CustInvoiceWriteoffs] W           where W.CustomerInvoiceID = CIS.InvoiceNumber            and [PaymentDate] >= DATEADD(day,-31, CAST(GETDATE() AS DATE))           ) as Writeoffs_in_the_last_30_days_USD                      ,[DisputeAmount] AS Dispute_Amount_Local --Not sure which currency is being used        ,[DisputeAmount] AS Dispute_Amount_USD --Not sure which currency is being used    ---------------------------------------------------------------------------------------      ,0 as Account_Amounts_Local  --TODO!!!      ,0 as Account_Amounts_USD  --TODO!!!                    FROM         [ankura_dw].[dbo].[CustInvoiceSummaries] CIS     join [Projects] P on CIS.[ProjectId] = P.[ProjectId]        where 1=1 -- and ProjectStatusCode in ('Active', 'Active - AR/Revenue/GL Use Only')    --and CIS.[AmountDue] <> 0    and CIS.Company = 'USD010 Ankura Consulting Group LLC'    and CIS.[InvoiceStatus] = 'Approved'    and CIS.[InvoiceDate] >= '2019-10-01'